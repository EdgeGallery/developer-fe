<!--
  -  Copyright 2020-2021 Huawei Technologies Co., Ltd.
  -
  -  Licensed under the Apache License, Version 2.0 (the "License");
  -  you may not use this file except in compliance with the License.
  -  You may obtain a copy of the License at
  -
  -      http://www.apache.org/licenses/LICENSE-2.0
  -
  -  Unless required by applicable law or agreed to in writing, software
  -  distributed under the License is distributed on an "AS IS" BASIS,
  -  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  -  See the License for the specific language governing permissions and
  -  limitations under the License.
  -->

---
apiVersion: v1              # pod信息
kind: Pod
metadata:
  name: positioning-service    # pod名
  namespace: '{{ .Values.appconfig.appnamespace }}'
  labels:
    app: positioning-service
spec:
  containers:
    - name: positioning    # 容器名
      image: '{{.Values.imagelocation.domainname}}/{{.Values.imagelocation.project}}/positioning_service:1.0'  # 镜像信息
      imagePullPolicy: IfNotPresent   # 镜像拉取策略
      ports:
        - containerPort: 9997         # 内部端口
    {{- if .Values.global.mepagent.enabled }}    # 是否依赖平台能力，没有这部分无法使用平台的能力
    - name: mep-agent
      image: '{{.Values.imagelocation.domainname}}/{{.Values.imagelocation.project}}/mep-agent:latest'
      imagePullPolicy: Always
      env:
        - name: ENABLE_WAIT
          value: "true"
        - name: MEP_IP
          value: "mep-api-gw.mep"
        - name: MEP_APIGW_PORT
          value: "8443"
        - name: CA_CERT_DOMAIN_NAME
          value: "edgegallery"
        - name: CA_CERT
          value: /usr/mep/ssl/ca.crt
        - name: AK
          valueFrom:
            secretKeyRef:
              name: '{{ .Values.appconfig.aksk.secretname }}'
              key: accesskey
        - name: SK
          valueFrom:
            secretKeyRef:
              name: '{{ .Values.appconfig.aksk.secretname }}'
              key: secretkey
        - name: APPINSTID
          valueFrom:
            secretKeyRef:
              name: '{{ .Values.appconfig.aksk.secretname }}'
              key: appInsId
      volumeMounts:
        - name: mep-agent-service-config-volume
          mountPath: /usr/mep/conf/app_instance_info.yaml
          subPath: app_instance_info.yaml
              
  volumes:
    - name: mep-agent-service-config-volume
      configMap:
        name: '{{ .Values.global.mepagent.configmapname }}'
  {{- end }}
---
apiVersion: v1                 # 服务信息
kind: Service
metadata:
  name: positioning-service    # 服务名
  namespace: '{{ .Values.appconfig.appnamespace }}'
  labels:
    svc: positioning-service
spec:
  type: NodePort
  ports:
    - port: 9997
      targetPort: 9997      # 内部端口
      protocol: TCP
      nodePort: 32218       # 暴露端口号3000-33000
  selector:
    app: positioning-service
